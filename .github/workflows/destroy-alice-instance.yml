name: Destroy-alice-instance
on:
  workflow_run:
    workflows:
      - "e8820s-official-openwrt-23.05.yml"
      - "e8820s-official-openwrt-24.10.yml"
    types: [completed]

jobs:
  on-finish:
    runs-on: ubuntu-latest
    steps:
      - name: Check & Delete Runner
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          REPO: ${{ github.repository }}
          RUNNER_NAME: self-hosted
        run: |
          echo "üîç Checking runner named '$RUNNER_NAME' ..."
          RUNNER_ID=$(curl -s -H "Authorization: token $GH_TOKEN" \
            https://api.github.com/repos/$REPO/actions/runners \
            | jq -r --arg NAME "$RUNNER_NAME" '.runners[]? | select(.name==$NAME) | .id')

          if [ -z "$RUNNER_ID" ] || [ "$RUNNER_ID" = "null" ]; then
            echo "‚ö†Ô∏è Runner '$RUNNER_NAME' not found ‚Äî skipping deletion."
          else
            echo "üßπ Found runner ID: $RUNNER_ID ‚Äî deleting..."
            curl -s -X DELETE \
              -H "Authorization: token $GH_TOKEN" \
              https://api.github.com/repos/$REPO/actions/runners/$RUNNER_ID
            echo "‚úÖ Runner deleted successfully."
          fi
